from django.http import HttpResponse, HttpResponseRedirect 
from reader.models import Feed, Article, Rating, Label
from django.template import Context, loader
from reader.forms import ArticleForm
from django.shortcuts import render_to_response, get_object_or_404
from django.template import RequestContext
from django.forms.models import modelformset_factory
from django.core.urlresolvers import reverse
import feedparser

#monkeypatch to allow video embeds. thx http://www.rumproarious.com/
feedparser._HTMLSanitizer.acceptable_elements = feedparser._HTMLSanitizer.acceptable_elements + ['object', 'embed','iframe']
#import bs4

#show starred. later: random, all feeds
def index(request):
    articles = Article.objects.filter(read_later__exact='True')
    ArticleFormSet=modelformset_factory(Article, fields=('unread', 'read_later'), extra=0)
    formset = ArticleFormSet(queryset=articles)
    feeds_labels =  Label.objects.all()
    return  render_to_response(
        'reader/index.html',
        {'formset':formset, 'feeds_labels':feeds_labels, 'articles':articles,},
        context_instance = RequestContext(request),
    )

#show specific feed
def detail(request, feed_id_pk):
    articles = Article.objects.filter(feed_id=feed_id_pk)
    ArticleFormSet=modelformset_factory(Article, fields=('unread', 'read_later'))
    formset = ArticleFormSet(queryset=Article.objects.filter(feed_id=feed_id_pk, unread=True))
    feeds_labels =  Label.objects.all()
    return  render_to_response(
        'reader/detail.html',
        {'formset':formset, 'feeds_labels':feeds_labels, 'articles':articles,},
        context_instance = RequestContext(request),
    )

#updates POST, no data returned
#currently, article ID is hard-coded, so it redirects to nyt after each update.
#gotta figure out how to do that dynamically
def update(request, feed_id_pk):
    ArticleFormSet=modelformset_factory(Article, fields=('unread', 'read_later'))
    #formset = ArticleFormSet(queryset=Article.objects.filter(feed_id=feed_id_pk))
    form = ArticleFormSet(request.POST, instance=)
    #article = Article.objects.get(id=article_id_pk)
    #form = ArticleForm(request.POST, instance=article)
    form.save()
    return HttpResponseRedirect(reverse('detail', args=(feed_id_pk)))



def testing(request, article_id_pk):
    article = Article.objects.get(id=article_id_pk)
    form = ArticleForm(request.POST, instance=article)
    if form.is_valid():
         result = "valid"
         form.save()
    else:
         result = "not valid"
    
    return  render_to_response(
        'reader/t.html',
        {'form':form, 'result':result, 'article':article},
        context_instance = RequestContext(request),
    )

    #article_id = int(request.POST['article_id'])
    #event = get_object_or_404(Article, id=article_id)
    #test get
    #article = Article.objects.get(id=165)
    #form = ArticleForm(request.POST, instance = article)
    # 
    # if form.is_valid():
    ##     result = "valid"
    #     a = form.save()
    #     article.unread = form.cleaned_data['unread']
    #     article.read_later = form.cleaned_data['read_later']
    # else:
    #     result = "not valid"
    #
    #return  render_to_response(
    #    'reader/t.html',
    #    {'form':form, 'result':result, 'article':article},
    #    context_instance = RequestContext(request),
    #)

    #labels = Label.objects.all()
    #template = loader.get_template('reader/t.html')
    #context = Context({
    #    'labels': labels,
    #})
    #return  HttpResponse(template.render(context))
